name: CuTE upgrade
description: CuTE upgrade
inputs:
  deploy-type:
    description: 'CI deploy type.'
    required: true
  upgrade-stable-version:
    description: 'Cilium stable Helm chart version.'
    required: true
  helm-version:
    description: 'Cilium Helm chart version.'
    required: true
  umbrella-chart-path:
    description: 'Path to Cilium umbrella Helm chart.'
    required: true
  cute-dir:
    description: 'Directory with a CuTE code/config.'
    required: true
  quay-org:
    description: 'Quay repo organization.'
    required: true
runs:
  using: composite
  steps:
    - name: CuTE Terraform variables file for stable upgrade
      if: inputs.upgrade-stable-version != ''
      working-directory: ./${{ inputs.cute-dir }}
      shell: bash
      run: |
        if [[ "${{ inputs.deploy-type }}" == "cute" ]]; then
          echo "cilium_helm_version=\"${{ inputs.upgrade-stable-version }}\"" >> terraform.tfvars
          # the below variables are for cluster mesh scenario
          echo "cilium_helm_version_1=\"${{ inputs.upgrade-stable-version }}\"" >> terraform.tfvars
          echo "cilium_helm_version_2=\"${{ inputs.upgrade-stable-version }}\"" >> terraform.tfvars
        else
          sed -i.bak "s/^cilium_helm_version=.*/cilium_helm_version=\"${{ inputs.upgrade-stable-version }}\"/g" terraform.tfvars
          sed -i.bak "s/^cilium_helm_version_1=.*/cilium_helm_version_1=\"${{ inputs.upgrade-stable-version }}\"/g" terraform.tfvars
          sed -i.bak "s/^cilium_helm_version_2=.*/cilium_helm_version_2=\"${{ inputs.upgrade-stable-version }}\"/g" terraform.tfvars
        fi
        cat terraform.tfvars

    - name: CuTE Terraform variables file for non-stable upgrade
      if: inputs.upgrade-stable-version == ''
      working-directory: ./${{ inputs.cute-dir }}
      shell: bash
      run: |
        HELM_CHART_VERSION=${{ inputs.helm-version }}
        if [[ -n "${{ inputs.umbrella-chart-path }}" ]]; then
          HELM_CHART=${{ inputs.umbrella-chart-path }}
        fi
          if [[ "${{ inputs.deploy-type }}" == "cute" ]]; then
          echo "cilium_helm_chart=\"oci://${{ env.helm_registry }}/${{ inputs.quay-org }}/cilium\"" >> terraform.tfvars
          echo "cilium_helm_version=\"$HELM_CHART_VERSION\"" >> terraform.tfvars
          # the below variables are for cluster mesh scenario
          echo "cilium_helm_version_1=\"$HELM_CHART_VERSION\"" >> terraform.tfvars
          echo "cilium_helm_version_2=\"$HELM_CHART_VERSION\"" >> terraform.tfvars
        else
          sed -i.bak "s/^cilium_helm_version=.*/cilium_helm_version=\"$HELM_CHART_VERSION\"/g" terraform.tfvars
          sed -i.bak "s/^cilium_helm_version_1=.*/cilium_helm_version_1=\"$HELM_CHART_VERSION\"/g" terraform.tfvars
          sed -i.bak "s/^cilium_helm_version_2=.*/cilium_helm_version_2=\"$HELM_CHART_VERSION\"/g" terraform.tfvars
        fi
        cat terraform.tfvars

    - name: CuTE upgrade
      working-directory: ./${{ inputs.cute-dir }}
      shell: bash
      run: |
        make upgrade AUTO_APPROVE=true

    - name: Wait for Cilium to be ready
      working-directory: ./${{ inputs.cute-dir }}
      shell: bash
      run: |
        cilium status --wait 15m0s
