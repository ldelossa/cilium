name: CuTE scheduled workflows

on:
  schedule:
    # Every Wednesday at 00:00
    - cron: "0 0 * * 3"
  workflow_dispatch:

permissions:
  # To be able to access the repository with actions/checkout
  contents: read
  # To trigger workflows via workflow_dispatch
  actions: write

jobs:
  cute-scheduled:
    name: CuTE Scheduled
    strategy:
      fail-fast: false
      matrix:
        cute: [
          {
            repo: sky,
            region: us-west-1
          },
          {
            repo: bloomberg,
            umbrella: true,
            region: us-west-2
          },
          {
            repo: form3,
            dir: MAKS,
            region: westus2
          },
          {
            repo: form3,
            dir: FPS,
            region: eu-west-2
          },
          {
            repo: zerohash,
            region: us-east-2
          },
          {
            repo: postfinance,
            region: eu-west-1
          },
          {
            repo: nationwide,
            umbrella: true,
            region: eu-central-1
          },
          {
            repo: swiss-post,
            dir: aws-eks-vpc-cni-chaining,
            region: ap-south-1
          },
          {
            repo: swiss-post,
            dir: azure-aks-byocni,
            region: eastus2
          },
          {
            repo: roche,
            region: eu-west-3
          },
          {
            repo: astrazeneca,
            region: ca-central-1
          },
          {
            repo: telenor,
            region: eu-north-1
          },
          {
            repo: adobe,
            region: ap-northeast-1
          },
        ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Manually run CuTE workflows
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REF=${GITHUB_REF#refs/heads/}
          dir="."
          [[ -n "${{ matrix.cute.dir }}" ]] && dir="${{ matrix.cute.dir }}"
          umbrella="false"
          [[ -n "${{ matrix.cute.umbrella }}" ]] && umbrella="${{ matrix.cute.umbrella }}"
          # Notification will be send to the `weaver-in` Slack channel and then routed to a proper destination channel
          args="repo=${{ matrix.cute.repo }}&dir=$dir&region=${{ matrix.cute.region }}&umbrella=$umbrella&deploy=stable&notify=C02T57KV69Y"
          echo "Triggering workflow for CuTE: $args"
          gh workflow run enterprise-cute.yaml --ref ${REF} -f extra-args="$args"
