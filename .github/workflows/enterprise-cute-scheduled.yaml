name: CuTE scheduled workflows

on:
  schedule:
    # Every Wednesday at 00:00
    - cron: "0 0 * * 3"
  workflow_dispatch:

permissions:
  # To be able to access the repository with actions/checkout
  contents: read
  # To trigger workflows via workflow_dispatch
  actions: write

jobs:
  cute-scheduled:
    name: CuTE Scheduled
    strategy:
      fail-fast: false
      matrix:
        cute: [
          { repo: sky, dir: ., region: us-west-1 },
          { repo: bloomberg, dir: ., region: us-west-2 },
          { repo: form3, dir: MAKS, region: westus2 },
          { repo: form3, dir: FPS, region: eu-west-2 },
          { repo: zerohash, dir: ., region: us-east-2 },
          { repo: postfinance, dir: ., region: eu-west-1 },
          { repo: nationwide, dir: ., region: eu-central-1 },
          { repo: motorola-solutions, dir: ., region: eu-west-3 },
        ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0
        with:
          persist-credentials: false

      - name: Manually run CuTE workflows
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REF=${GITHUB_REF#refs/heads/}
          echo "Triggering workflow for CuTE: ${{ matrix.cute.repo }}/${{ matrix.cute.dir }}"
          gh workflow run enterprise-cute.yaml \
            --ref ${REF} \
            -f context-ref=${REF} \
            -f extra-args="${{ matrix.cute.repo }}/${{ matrix.cute.dir }}~${{ matrix.cute.region }}" \
            -f use-stable-branch="true"
