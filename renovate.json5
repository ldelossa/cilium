{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:base",
    ":gitSignOff",
    "helpers:pinGitHubActionDigests"
  ],
  // This ensures that the gitAuthor and gitSignOff fields match
  "gitAuthor": "renovate[bot] <bot@renovateapp.com>",
  "includePaths": [
    ".github/actions/set-env-variables/enterprise-overrides.sh",
    ".github/workflows/enterprise-*",
    "images/cilium/download-hubble-enterprise.sh"
  ],
  "pinDigests": true,
  "ignorePresets": [":prHourlyLimit2"],
  "separateMajorMinor": true,
  "separateMultipleMajor": true,
  "separateMinorPatch": true,
  "pruneStaleBranches": true,
  "baseBranches": [
    "main-ce",
    "v1.16-ce",
    "v1.15-ce",
    "v1.14-ce",
    "v1.13-ce",
  ],
  "vulnerabilityAlerts": {
    "enabled": true
  },
  "labels": [
    "renovate/stop-updating",
    "kind/enhancement",
    // Pull requests from Renovate do not show up in release notes by default.
    // Override the release-note label in the packageRules section below for
    // those dependencies that are relevant to end users.
    "release-note/ignore",
  ],
  "stopUpdatingLabel": "renovate/stop-updating",
  "packageRules": [
    {
      "groupName": "Cilium CLI Enterprise",
      "groupSlug": "cilium-cli-ee",
      "ignoreUnstable": false,
      "matchDepNames": [
        "isovalent/cilium-cli-releases",
      ],
    },
    {
      // Don't update CILIUM_CLI_VERSION environment variable in main-ce branch.
      // CILIUM_CLI_VERSION is only used in stable branches to pick up the
      // latest released version of cilium-cli to run connectivity tests. In
      // main-ce branch, CI workflows always build cilium-cli locally to run
      // connectivity tests using the latest unreleased code.
      "enabled": false,
      "matchDepNames": [
        "isovalent/cilium-cli-releases",
      ],
      "matchBaseBranches": [
        "main-ce",
      ],
    },
    {
      "groupName": "Hubble CLI Enterprise",
      "groupSlug": "hubble-cli-ee",
      "ignoreUnstable": false,
      "labels": [
        "renovate/stop-updating",
        "kind/enhancement",
        "release-note/misc",
      ],
      "matchDepNames": [
        "isovalent/hubble-releases",
      ],
    },
    {
      "groupName": "all github action dependencies in enterprise workflows",
      "groupSlug": "all-github-action",
      "matchFileNames": [
        ".github/workflows/enterprise-*"
      ],
      excludeDepNames: [
        "quay.io/cilium/kindest-node"
      ],
      "matchUpdateTypes": [
        "major",
        "minor",
        "digest",
        "patch",
        "pin",
        "pinDigest"
      ],
      "schedule": [
        "on monday"
      ]
    },
    // Ref: https://github.com/cilium/cilium-cli#releases
    {
      "groupName": "Cilium CLI",
      "groupSlug": "cilium-cli",
      "matchDepNames": [
        "cilium/cilium-cli"
      ],
      "allowedVersions": "/^v0\\.14\\.[0-9]+$/",
      "matchBaseBranches": [
        "v1.13-ce",
      ]
    },
    {
      "matchPackageNames": [
        "docker.io/library/ubuntu"
      ],
      "allowedVersions": "22.04",
      "matchBaseBranches": [
        "v1.13-ce"
      ],
    },
    {
      "matchPackageNames": [
        "docker.io/library/golang",
        "go"
      ],
      "allowedVersions": "<1.23",
      "matchBaseBranches": [
        "v1.13-ce"
      ]
    },
    {
      "matchPackageNames": [
        "docker.io/library/alpine"
      ],
      "allowedVersions": "<3.18",
      "matchBaseBranches": [
        "v1.13-ce"
      ]
    },
    {
      "matchPackageNames": [
        "quay.io/cilium/certgen",
      ],
      "allowedVersions": "<0.2.0",
      "matchBaseBranches": [
        "v1.13-ce"
      ]
    },
    {
      "groupName": "all kind-images",
      "groupSlug": "all-kind-images",
      "matchPackageNames": [
        "kindest/node",
        "quay.io/cilium/kindest-node"
      ],
      "matchUpdateTypes": [
        "digest",
        "patch",
        "pin",
        "pinDigest"
      ],
      "schedule": [
        "on monday"
      ],
    },
    {
      "matchDepNames": [
        "quay.io/lvh-images/complexity-test",
        "quay.io/lvh-images/kind"
      ],
      "versioning": "regex:^((?<compatibility>[a-z-]+)|((?<major>\\d+)\\.(?<minor>\\d+)))\\-(?<patch>\\d+)\\.(?<build>\\d+)(@(?<currentDigest>sha256:[a-f0-9]+))?$"
    },
    {
      "groupName": "stable lvh-images",
      "groupSlug": "stable-lvh-images",
      "matchPackageNames": [
        "cilium/little-vm-helper",
        "quay.io/lvh-images/complexity-test",
        "quay.io/lvh-images/kind"
      ],
      "allowedVersions": "!/bpf-next-.*/",
      "matchBaseBranches": [
        "v1.13-ce"
      ],
    },
    {
      // Do not allow any updates for major.minor, they will be done by maintainers
      "enabled": false,
      "matchPackageNames": [
        "quay.io/lvh-images/complexity-test",
        "quay.io/lvh-images/kind",
        "kindest/node",
        "quay.io/cilium/kindest-node"
      ],
      "matchUpdateTypes": [
        "major",
        "minor"
      ],
    },
    {
      "matchPackageNames": [
        "quay.io/cilium/kindest-node"
      ],
      "ignoreUnstable": false,
    },
    {
      "matchDepNames": [
        "quay.io/cilium/cilium-envoy"
      ],
      "versioning": "regex:v(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)-(?<build>\\d+).*$",
      "allowedVersions": "<1.29",
      "matchBaseBranches": [
        "v1.13-ce"
      ]
    }
  ],
  "regexManagers": [
    {
      "fileMatch": [
        ".github/actions/set-env-variables/enterprise-overrides.sh",
      ],
      "matchStrings": [
        "# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?)\\s+CILIUM_CLI_VERSION=\"(?<currentValue>.*)\"",
      ]
    },
    {
      "fileMatch": [
        "images/cilium/download-hubble-enterprise\\.sh",
      ],
      // These regexes manage version and digest strings in shell scripts,
      // similar to the examples shown here:
      //   https://docs.renovatebot.com/modules/manager/regex/#advanced-capture
      "matchStrings": [
        "# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?)\\s+.+_version=\"(?<currentValue>.*)\"",
        // The digestVersion in this regex is required for Renovate to be able
        // to match the digest to the pinned version. It will not work without it.
        // Note that for GitHub release artifact digests, you likely want to use
        // github-release-attachments as the datasource here.
        "# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?) digestVersion=(?<currentValue>.*)\\s+.+_sha256.*=\"(?<currentDigest>.*)\""
      ]
    },
    {
      "fileMatch": [
        "^\\.github/workflows/enterprise-[^/]+\\.ya?ml$",
      ],
      // This regex manages version strings in GitHub actions workflow files,
      // similar to the examples shown here:
      //   https://docs.renovatebot.com/modules/manager/regex/#advanced-capture
      "matchStrings": [
        "# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?)\\s+.+version: (?<currentValue>.*)",
        "# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?)(?: registryUrl=(?<registryUrl>.+?))\\s+.+_VERSION: (?<currentValue>.*)",
        "# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?)\\s+.+kernel: '(?<currentValue>.*)'",
        '# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*)\\s+.+kernel: "(?<currentValue>.*)@(?<currentDigest>sha256:[a-f0-9]+)"',
        '# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*)\\s+.+image-version: "(?<currentValue>.*)@(?<currentDigest>sha256:[a-f0-9]+)"',
        '# renovate: datasource=(?<datasource>.*?)\\s+.+kube-image: "(?<depName>.*):(?<currentValue>.*)@(?<currentDigest>sha256:[a-f0-9]+)"'
      ]
    },
    {
      "fileMatch": [
        "^enterprise/cilium-cli/go\\.mod$",
      ],
      "matchStrings": [
        "// renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?)\\s+.+go (?<currentValue>.*)"
      ]
    }
  ]
}
