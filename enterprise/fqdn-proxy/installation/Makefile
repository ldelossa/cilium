# Copyright Authors of Cilium
# SPDX-License-Identifier: Apache-2.0

MAKEFILE_VALUES?=Makefile.values
include $(MAKEFILE_VALUES)
include ../../../Makefile.defs

ifeq ($(CILIUM_DNSPROXY_VERSION),)
export CILIUM_DNSPROXY_VERSION:=v$(VERSION)
endif

DNSPROXY_CHARTS := $(ROOT_DIR)/$(RELATIVE_DIR)
CHART_FILE := "$(DNSPROXY_CHARTS)/Chart.yaml"

VALUES_TMPL_FILE_NAME ?= values.yaml.tmpl

VERSION_REGEX := '[0-9]\+\.[0-9]\+\.[0-9]\+.*'
DNSPROXY_CHART_REGEX := '\([vV]ersion:\) '$(VERSION_REGEX)

define generate_values_yaml
echo -e "# File generated by $(RELATIVE_DIR)/Makefile; DO NOT EDIT." > $(2); \
echo -e "# This file is based on $(RELATIVE_DIR)/cilium/$(VALUES_TMPL_FILE_NAME).\n" >> $(2); \
cat $(1) | envsubst >> $(2)
endef

all: update-versions

update-chart: $(ROOT_DIR)/VERSION # Update chart versions to point to the current version.
	$(ECHO_GEN)enterprise/fqdn-proxy/Chart.yaml
	$(QUIET)grep -lR -e 'version:' -e 'appVersion:' $(DNSPROXY_CHARTS)/ \
		| xargs -L 1 $(SED) -i -e 's/'$(DNSPROXY_CHART_REGEX)'/\1 '$(VERSION)'/g'

values.yaml: $(VALUES_TMPL_FILE_NAME) $(ROOT_DIR)/VERSION $(MAKEFILE_VALUES)
	$(ECHO_GEN)$@
	$(call generate_values_yaml,$(VALUES_TMPL_FILE_NAME),$@)

update-versions: update-chart values.yaml # Update the Helm values file to point to the current version.

.PHONY: all update-chart
